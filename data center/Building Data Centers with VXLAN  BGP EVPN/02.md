### 1. 資料中心環境的背景與挑戰 (Context and Challenges)

資料中心流量模式已從傳統的客戶端到伺服器（南北向流量）轉變為伺服器間的通訊（東西向流量），例如多層次應用程式伺服器與資料庫伺服器之間的交換。

*   **VLAN 限制**：傳統網路中，虛擬區域網路（VLAN）使用 12 位元標籤，限制了廣播域的最大數量為 4096 個 (4K)。這對於需要數千個租戶網路的多租戶雲端部署來說遠遠不足。
*   **主機擴展性問題**：虛擬化使得單一實體伺服器承載了數十倍於傳統網路的主機或虛擬機（VMs），導致交換器面臨 **MAC 表爆炸** 和控制平面開銷激增的問題（如處理 DHCP, ARP, ND, IGMP 等協議）。
*   **STP 局限**：傳統的生成樹協定（STP）存在收斂時間長、鏈路利用率低（存在阻斷鏈路）、無法提供等價多路徑（ECMP）路由等固有缺陷，難以滿足現代資料中心的高可用性和頻寬需求。

![East–West Communication Flow](images/2-1.png) East–West Communication Flow

### 2. Overlays（覆蓋網路）

覆蓋網路（Overlays）是解決傳統網路挑戰的關鍵架構轉變，它提供了一個抽象層，允許網路功能與底層傳輸網路分離。

*   **身份與位置分離**：覆蓋網路的核心是將終端主機的「身份」（Identity，如 MAC/IP 位址）與承載其的網路設備的「位置」（Location，如 VTEP IP）分離。
*   **封裝類型**：
    *   **訊框封裝（Frame Encapsulation）**：外層是 Layer 2 訊框，例如 TRILL 和 Cisco FabricPath。
    *   **封包封裝（Packet Encapsulation）**：外層是 Layer 3 封包，例如 VXLAN 和 LISP。
*   **底層網路（Underlay）**：負責在隧道邊緣設備（如 VTEP）之間提供連通性，通常是一個強健的 Layer 3 IP 網路。
    * 對於 VXLAN，底層傳輸網路（底層）將是一個第3層網路，用於在源端與目的端隧道邊緣設備之間傳輸 VXLAN 封裝的封包
*   **VTEP（VXLAN Tunnel Endpoint）**：是*邊緣設備*上的功能，負責執行覆蓋網路標頭的封裝和解封裝。
*   **VNI（Virtual Network Identifier）**：是識別覆蓋服務的標識符。

在覆蓋網路中，原始封包或幀(frame)會在邊緣設備上使用外部標頭進行封裝，然後發送到適當的目的邊緣設備。*中間的網路設備都會根據外部標頭轉發封包*，而不會察覺原始的有效載荷。在目的邊緣設備上，覆蓋標頭會被去除，然後封包會根據內部有效載荷進行轉發。

對於部署中同時存在裸機和虛擬化工作負載的情況，ToR（Top-of-Rack）交換機負責為其下各類工作負載處理覆蓋網路標頭的推送/彈出。這些稱為網路覆蓋（network overlays）。無論是主機覆蓋（host overlays）還是網路覆蓋都非常受歡迎，是*解決多租戶數據中心環境中規模挑戰的常見部署選項*。每種方案都有其優缺點，但通過使用混合覆蓋環境（hybrid overlay environments），可以實現兩全其美，該環境同時支持主機覆蓋和網路覆蓋，從而優化物理到虛擬（P2V）通訊。

![Host, Network, and Hybrid Overlays](images/2-2.png) Host, Network, and Hybrid Overlays

底層傳輸網路（或稱底層網路）通常由互聯邊緣設備的中繼設備組成。邊緣設備作為底層網路的邊界設備，連接端主機以及不支援疊加的設備。在邊緣設備中，存在用於封裝和解封疊加數據流量以及構建整個疊加網路的功能。在 VXLAN 術語中，*邊緣設備上的這種功能稱為 VTEP，即 VXLAN 隧道端點*。下圖說明了 VXLAN 下層網路中涉及的關鍵術語和功能。

![Underlay Taxonomy](images/2-3.png) Underlay Taxonomy

VXLAN，這些服務會透過虛擬網路識別碼 (VNI) 來明確識別，這大大擴展了在網路中容納更多廣播域的能力。這些特性使得 VXLAN 非常具有吸引力。下圖說明了 VXLAN 覆蓋網中涉及的關鍵術語與功能。

![Overlay Taxonomy](images/2-4.png) Overlay Taxonomy

> 覆蓋網路每個封包/幀會產生 n 位元組的額外負載，其中 n 為覆蓋標頭及相關外部標頭的大小。原始有效負載被封裝進覆蓋標頭後，會透過底層網路傳輸；因此，底層網路必須配置適當的最大傳輸單位（MTU），以確保覆蓋流量的傳遞。


### 3. Introduction to VXLAN (VXLAN 簡介)

VXLAN 是一種 **MAC-in-IP/UDP** 封裝，是目前資料中心最流行的覆蓋協定。

*   **擴展性**：VXLAN 提供了 24 位元 VNI 空間，可支援高達 1600 萬個虛擬網路段，極大地解決了 4K VLAN 的限制。
*   **ECMP 支援**：由於 VXLAN 運行在 IP 網路上，它可以原生地利用底層 Layer 3 網路的 ECMP 功能，提高鏈路利用率。
*   **訊框格式和開銷**：VXLAN 訊框格式包括原始的 Layer 2 訊框（內層）和新增的 VXLAN/UDP/IP/Ethernet 標頭（外層）。這會增加 50 或 54 位元組的封裝開銷。查看圖 VXLAN Frame Format Details
*   **UDP 源埠熵（Entropy）**：為了在 IP Underlay 上實現流量的負載均衡（ECMP），VXLAN 根據內層封包的內容生成可變的 UDP 源埠號碼（Source Port），確保流量流經不同的等價路徑。
        * 由於 UDP 來源端口會根據內部封包/幀的內容而變化，它提供了必要的熵來為相同來源與目的 VTEP 對之間的不同終端主機流選擇不同的路徑。
*   **BUM 流量處理**：VXLAN 需要機制來傳輸廣播、未知單播和多播（BUM）流量。主要方式包括：
    *   **IP Multicast**：在底層網路運行 IP 多播協議（如 PIM），將 VNI 對應到一個 IP 多播組。
    *   **Ingress Replication (IR)**：由源 VTEP 產生多個副本，單播給所有目標 VTEP。
*   **缺乏控制平面**：最初的 VXLAN 標準定義了資料平面，但缺乏內建的控制平面來分發主機可達性信息，因此必須依賴下一節所述的 F&L 機制。

VXLAN 代表了一種二層嵌入三層的覆蓋網路(Overlay network)。邊緣設備負責通過所承載的 VTEP 功能推入和彈出 VXLAN 標頭。本質上，VXLAN 可以在三層網路上連接兩個或多個網路，同時允許這些不同網路上的工作負載或伺服器繼續*共享相同的二層廣播域*。*透過在 VXLAN 中使用三層，VTEP 之間的所有可能路徑都可以透過 ECMP 使用，這也大大提高了底層網路的利用率*。

VXLAN 標頭的內部部分指的是第 2 層組件，而外部標頭則反映第 3 層邊緣設備。VXLAN 標頭前面是外層 UDP 標頭(outer UDP header)、外層 IP 標頭(outer IP header)以及外層以太網標頭(outer Ethernet header)。外層 UDP 標頭的目的地埠號設置為 4789。

![VXLAN Frame Format](images/2-5.png) VXLAN Frame Format

![VXLAN Frame Format Details](images/2-6.png) VXLAN Frame Format Details

### 4. VXLAN Flood and Learn (F&L)

在沒有控制平面的情況下，VXLAN 使用 F&L 機制來學習遠端主機的 MAC-to-VTEP 綁定。

*   **學習過程**：當 Host A 嘗試與遠端 Host B 通訊時：
    1.  Host A 發送 ARP 請求（廣播）。
    2.  源 VTEP 接收 ARP 請求，將其封裝為 VXLAN，並使用對應 VNI 的多播組（或 IR）轉發給所有相關 VTEP。
    3.  所有目標 VTEP 收到 BUM 流量，並執行 Layer 2 學習，記錄 Host A 的 MAC 位址與源 VTEP 的 IP 位址綁定。
    4.  Host B 回覆 ARP 響應（單播），目標 VTEP 根據學習到的 MAC-to-VTEP 綁定，將響應單播回源 VTEP。
    5.  後續流量可直接單播傳輸。

    ![VXLAN F&L](images/2-7.png) VXLAN F&L

*   **F&L 缺點**：雖然 F&L 能夠實現主機學習，但它本質上是一種**基於泛洪（Flooding）** 的機制。當廣播域跨越 Layer 3 邊界擴展時，大量泛洪會嚴重影響網路可擴展性。

與 VLAN 另外主要的區別在於 VXLAN VNI 域跨越了基於 IP 的第 3 層網路。

![VLAN-to-VNI Mapping](images/2-8.png) VLAN-to-VNI Mapping

> 在 VXLAN 環境中處理多目的地流量的一種替代 IP 多播的方法是使用入口複製（IR），或稱端點複製。

### 5. Introduction to BGP EVPN with VXLAN (結合 BGP EVPN 的 VXLAN 簡介)

BGP EVPN 為 VXLAN 提供了標準化的控制平面，解決了 F&L 機制帶來的擴展性瓶頸。

*   **控制平面角色**：BGP（邊界網關協定）是一種硬狀態協議，具有優異的擴展性。EVPN 擴展允許 BGP 作為一個數據目錄，傳輸所有 MAC/IP 地址與 VTEP 的綁定信息。
*   **優勢**：
    *   **減少泛洪**：一旦主機在本地 VTEP 被學習到，其可達性訊息會通過 BGP EVPN 分發給所有相關 VTEP，從而消除對未知單播流量的泛洪需求。
    *   **高效轉發**：通過集成路由和橋接（IRB），EVPN 能夠同時處理 Layer 2 和 Layer 3 流量轉發。
*   **注意**：BGP EVPN **並未完全消除** 泛洪，因為 ARP/DHCP 等廣播流量仍需通過底層網路的多播或 Ingress Replication 進行傳輸。但它極大地減少了由於學習過程產生的泛洪。

EVPN 在 VXLAN 中的源 VTEP 與目標 VTEP 之間傳輸信息，使用 BGP/MP-BGP 格式來標識 VTEP 背後特定 IP 和 MAC 地址目的地的可達性。總而言之，EVPN 位址族系 (address family) 允許主機的 MAC、IP、network、VRF 和 VTEP 資訊透過 MP-BGP 傳送。如此一來，只要某個 VTEP 透過 ARP/ND/DHCP 等方式學習到其連接的主機，*BGP EVPN 就會將此資訊分發並提供給網路中所有其他運行 BGP EVPN 的 VTEP*。只要來源端的 VTEP 能持續偵測到其連接的主機，它就不會發送 EVPN 更新訊息。因此，其他 VTEP 無需「老化清除」(age out) 任何遠端主機的可達性資訊。這可以防止在典型的 F&L (泛洪與學習) 情境中可能發生的任何因老化機制所引起的變動，從而大幅提升網路的可擴展性 (scalability)。

>將 BGP EVPN 與 VXLAN 結合使用，提供了一種改進的數據傳輸促進和控制方式，使網路中被識別的特定主機數量可以呈指數增長。

### 6. MP-BGP Features and Common Practices (MP-BGP 特性和常見實踐)

VXLAN BGP EVPN 解決方案基於 RFC 4760 定義的**多協定 BGP (MP-BGP)**。

* **iBGP 與 RR**：在單一自治系統（AS）內，內部 BGP (iBGP) 原則上要求全網狀（Full-Mesh）的對等關係。為了解決擴展性問題，通常部署 **路由反射器（Route Reflector, RR）** 來反射路由，避免 $N(N-1)/2$ 的會話開銷。
    * iBGP 主要用於在整個 AS 內的所有路由器之間同步交換資訊。
    * RR 被允許接收來自 iBGP 的資訊，然後將這些資訊「反射」給它的所有 RR 客戶端 (clients)——也就是所有已知的 iBGP 鄰居。
    * iBGP 和 RR 功能，從而無需再使用全網狀的架構
    ![iBGP with a Route Reflector](images/2-9.png) iBGP with a Route Reflector

* **eBGP**：外部 BGP (eBGP) 用於不同 AS 之間的對等連接。如下圖
    * 不需要有全網狀需求，從 eBGP 鄰居收到的 BGP 可達性資訊，一律會轉發給它所有的鄰居

一個位於 AS 65500 的 BGP 路由器，可以和它那位於 AS 65501 的鄰居 BGP 路由器建立對等體關係。

![eBGP with no Route Reflector](image.png)eBGP with no Route Reflector

* **路由識別碼（Route Distinguishers, RDs）**：8 位元組字段，用於確保多個租戶（VRF）即使使用重疊的 IP 地址空間，其路由條目在 BGP 表中仍然具有**唯一性**。常用的最佳實踐是針對每個 VRF 在每個路由器上使用唯一的 RD，如此一來，每個邏輯上的虛擬路由器實例都能被獨立識別。
    * MP-BGP 以其多租戶 (multitenancy) 和路由策略 (routing policy) 的能力而聞名
    * 用於唯一識別 BGP 表中條目的前綴
    
    ![Route Distinguisher Formats and Types](images/2-11.png) Route Distinguisher Formats and Types

* **路由目標（Route Targets, RTs）**：MP-BGP 的路由策略 (route policies) 用來控制特定邏輯實例 (logical instance) 中的路由，控制路由前綴的導入和導出策略，決定哪些路由可以被特定的 VRF 實例接收。
    * 一個 RT 屬性可以被認為是識別一組 VRF

  ![Route Target Concept](images/2-12.png) Route Target Concept

|  |  | |
|---|---|---|
|屬性|RD (路由識別碼)|RT (路由目標)|
|目的|確保路由的唯一性|控制路由的進出口策略|
|比喻|身分證號碼|通行證 / 貨物標籤|
|作用|使重疊的 IP 位址變成全域唯一的路由|決定一條路由可以被哪些 VRF 共享或接收|

在 VXLAN 的情境中，重點則是 L2VPN EVPN 這個位址族系(address families)，它定義了如何在單一的 MP-BGP 對等體 (peering session) 上，傳輸帶有租戶識別的 Layer 2 (MAC 位址) 和 Layer 3 (IP 位址) 資訊。

> MP-BGP 的位址族系 (address families) 是用來傳輸特定類型的可達性資訊。
> iBGP 有一條嚴格的規則：從一個 iBGP 鄰居學習到的路由資訊，*絕不能再轉傳給任何其他的 iBGP 鄰居*。為了確保所有路由器都能收到所有路由，iBGP 預設需要建立**「全網狀」(full-mesh)** 的對等體關係，也就是每台路由器都必須跟其他所有路由器建立連線。

### 7. IETF Standards and RFCs (IETF 標準和 RFC)
// to do
EVPN 的通用控制平面規範於 **RFC 7432** 中定義。

*   **關鍵 EVPN 路由類型**：VXLAN BGP EVPN 主要使用以下三種路由類型來實現功能：

| 路由類型 (RT) | 名稱 | 作用 | 關鍵信息 |
| :---: | :---: | :---: | :---: |
| RT 2 | MAC/IP 宣告路由 | 分發主機的 MAC 和 IP 可達性信息（主機路由）。 | MAC 地址、IP 地址（可選）、L2 VNI (Label 1)、L3 VNI (Label 2，路由時使用)。 |
| RT 3 | 包含式多播乙太網標籤路由 | 建立動態分發列表，供 Ingress Replication 使用，用於傳輸 BUM 流量。 | VTEP IP 地址、VNI。 |
| RT 5 | IP 前綴路由 | 傳輸 IP 子網或外部路由信息。主要用於 Layer 3 路由操作和靜默主機發現。 | IP 前綴、IP 前綴長度、L3 VNI。 |

*   **VNI 標籤**：在 RT-2 路由中，L2 VNI 使用 **MPLS Label 1**，L3 VNI 使用 **MPLS Label 2** 承載。

### 8. Host and Subnet Route Distribution (主機和子網路由分發)

VTEP 負責將本地學習到的主機信息注入到 BGP EVPN 控制平面。

*   **MAC 學習與分發**：
    1.  VTEP 通過 Layer 2 傳統學習（如 [VLAN, SMAC]）發現本地 MAC 地址。
    2.  VTEP 構造 **RT-2 消息 (僅 MAC)**，包含 MAC 地址、L2 VNI 和 RD/RT，通過 BGP 傳播（IPv4 RT-2 僅 MAC 路由前綴為 **/216**）。
*   **MAC/IP 綁定與分發**：
    1.  VTEP 接收到 ARP 請求後，通過 ARP 偵聽（ARP snooping）獲得主機的 IP-MAC 綁定。
    2.  VTEP 構造 **RT-2 消息 (MAC/IP)**，包含 MAC、IP 地址、L2 VNI 和 L3 VNI。此時 BGP 消息中會包含 **Router MAC (RMAC)** 作為擴展社群屬性，用於 VXLAN 封裝時作為內層 DMAC。
    3.  IPv4 RT-2 MAC/IP 路由前綴為 **/272**。
*   **IP 子網路由分發 (RT-5)**：
    1.  RT-5 路由（前綴長度可變）用於承載 IP 子網或外部路由信息。
    2.  主要用途包括：a) 宣告 **IRB（Distributed IP Anycast Gateway）** 的子網前綴，用於吸引流量以發現**靜默主機（Silent Endpoints）**。b) 注入外部路由信息。
    3.  RT-5 消息同樣包含 L3 VNI、RMAC 和 RT。

### 9. Host Deletion and Move Events (主機刪除和移動事件)

BGP EVPN 通過序列號和軟狀態機制，高效處理主機的變動，避免傳統網路的 MAC 老化（Aging）導致的連通性問題。

*   **主機刪除**：主機離線後，如果 ARP 條目超時（NX-OS 預設 1500 秒），VTEP 會嘗試 ARP 刷新。若無回應，則刪除 ARP 條目並撤回 RT-2 路由（MAC/IP）。MAC-only 的 RT-2 路由將在 MAC 老化計時器（預設 1800 秒）超時後撤回。
*   **主機移動（Mobility）**：當主機（例如 VM）從一個 VTEP 移動到另一個 VTEP 時：
    1.  新 VTEP 偵測到主機（通常通過 RARP 或 GARP）。
    2.  新 VTEP 發送新的 RT-2 消息，並在 **MAC Mobility Sequence Number** 字段中增加序列號。
    3.  序列號作為**決策依據（Tiebreaker）**，確保所有 VTEP 立即轉向新的位置，實現快速收斂。
    4.  舊 VTEP 驗證移動事件（防止重複 MAC/IP 情況），然後撤回舊的路由。
    5.  BGP EVPN 也包含重複地址偵測機制（例如 180 秒內移動 5 次）。
## VXLAN/EVPN 轉發特性 (VXLAN/EVPN Forwarding Characteristics) 重點整理

資料中心需要在所有層級和元件中保持高可用性。同樣，資料中心網路架構也必須提供冗餘以及動態路由分配。VXLAN BGP EVPN 從多個角度提供冗餘。在 VXLAN 邊緣裝置或 VTEP 之間的第 3 層路由底層提供了韌性以及多路徑功能。
透過多機箱鏈路聚合（multichassis link aggregation）或虛擬 PortChannel（vPC）連接傳統乙太網端點，提供雙宿功能，即使在 VTEP 發生故障時，也能確保容錯。

本章節深入探討 VXLAN BGP EVPN 網路架構的核心轉發能力，包括 BUM 流量處理、透過整合路由和橋接（IRB）實現的分散式 IP Anycast 閘道，以及針對端點移動性（Endpoint Mobility）和雙歸屬（Dual-Homed）部署的優化功能。

### 多目標流量 (Multidestination Traffic)

多目標流量（BUM：廣播 Broadcast、未知單播 Unknown Unicast 和多播 Multicast）的處理是 VXLAN 網路設計的關鍵環節。VXLAN BGP EVPN 提供兩種主要機制來處理這些流量。

#### 1. 利用底層網路的多播複製 (Leveraging Multicast Replication in the Underlying Network)

此方法要求在底層網路 (Underlay) 中配置 IP 多點傳播 (IP multicast)（例如 PIM），以實現網路基礎的複製機制。

*   **機制與優勢：** 始發 VTEP 只發送單一 BUM 流量副本進入底層網路。網路中的路由器在必要的分支點進行複製，確保只有感興趣的 VTEP 接收到流量。這是轉發 BUM 流量最有效率的方式，因為它在網路上保持了「單一副本」。
*   **VNI 與多播組的映射：** 每個 Layer 2 VNI (L2VNI) 都被映射到一個特定的 IP 多播組，此映射必須在所有參與該 L2VNI 的 VTEP 上保持一致配置。
*   **配置一致性：** 所有 VTEP 必須針對同一 L2VNI 遵循相同的多目標配置模式，且在多播模式下，必須使用相同的 PIM 協定類型（ASM 或 BiDir）。

#### 2. 使用入口複製 (Using Ingress Replication, IR)

入口複製（又稱頭端複製 Head-End Replication, HER 或單播模式 Unicast Mode）是一種不依賴底層多播的單播方法。

*   **機制：** 入口 VTEP 負責複製每一個 BUM 封包 N-1 次，並將其作為單獨的單播流發送給所有擁有該 L2VNI 成員資格的遠端 VTEP。
*   **控制平面協作：** BGP EVPN 透過 **Route Type 3 (Inclusive Multicast Ethernet Tag Route)** 訊息來動態分發 VTEP 及其 VNI 成員資格資訊，從而建構複製列表。
*   **性能考量：** 雖然此模式簡化了底層網路的複雜性（無需運行 PIM 多播），但它會在入口 VTEP 和底層鏈路上產生巨大的流量開銷，尤其是在 VTEP 數量較多或 BUM 流量較大的環境中，效率遠不如多播模式。

### VXLAN BGP EVPN 增強功能 (VXLAN BGP EVPN Enhancements)

為了進一步減少 VXLAN 網路中不必要的廣播流量並提高轉發效率，EVPN 引入了多項優化功能。

#### 1. ARP 抑制與未知單播抑制 (ARP Suppression and Unknown Unicast Suppression)

在傳統的 Flood and Learn 網路中，ARP 廣播是必須的，但在大規模數據中心中會嚴重影響效能。

*   **ARP 抑制機制：** 透過 ARP Snooping 和 BGP EVPN 控制平面，VTEP 可以學習本地連接端點的 IP-MAC 綁定資訊。當本地端點發送 ARP 請求給已知遠端端點時，VTEP 會在本地攔截該請求，並作為 ARP Proxy 立即發送單播 ARP 回覆，從而阻止 ARP 廣播進入 VXLAN 核心網。
*   **沉默端點處理：** 如果 ARP 查找結果為「遺失」（端點未知或為沉默端點），ARP 請求仍會作為 BUM 流量泛洪到 VXLAN 網路中，以便觸發目的端點回應，進而學習其資訊。
*   **未知單播抑制：** 這是一個獨立功能，可以針對每個 L2 VNI 啟用，用於抑制因 DMAC 查找失敗而引起的泛洪流量進入 VXLAN 網路。

#### 2. 分散式 IP Anycast 閘道 (Distributed IP Anycast Gateway, DIPAG)

DIPAG 是 EVPN 架構的關鍵優勢，它將傳統集中式閘道的功能分散到每個 Leaf/ToR 交換機上。

*   **演進：** 從傳統在匯聚層（Aggregation Layer）的集中式閘道（需仰賴 HSRP/VRRP 等 FHRP 協定）轉變為分散式閘道，將 Layer 3 邊界移至葉層（Leaf Layer）。
*   **機制：** 所有 Leaf 交換機共用相同的預設閘道 IP 位址，以及相同的 **Anycast 閘道 MAC 位址 (AGM)**。這消除了對 FHRP 協定的需求，並確保無論端點移動到 Fabric 內的哪個位置，其 ARP 快取中的預設閘道 IP-MAC 綁定保持不變，實現無縫移動性。
*   **沉默端點的路由處理：** 當流量發往一個未知的沉默端點時，如果路由表缺乏精確的 /32 主機路由，它會匹配由 VTEP 透過 **Route Type 5** 廣播的 **IP 子網前綴路由**。這個路由會將流量引導至服務該子網的 VTEP，VTEP 會觸發 ARP 請求以發現該沉默端點。

#### 3. 整合路由和橋接 (Integrated Route and Bridge, IRB)

IRB 功能在 VTEP 處同時實現 Layer 2 橋接和 Layer 3 路由，是實現 DIPAG 的核心技術。

*   **非對稱 IRB (Asymmetric IRB)：** 遵循 **橋接-路由-橋接** 的操作模式。去程和回程流量使用**不同的** Layer 3 VNI (L3VNI) 進行封裝，要求所有 VTEP 必須配置所有相關的 L2VNI，配置維護相對複雜。
*   **對稱 IRB (Symmetric IRB)：** Cisco NX-OS 實作採用此模式。遵循 **橋接-路由-路由-橋接** 的操作模式。去程和回程流量都使用與 VRF 關聯的**相同** L3VNI 進行封裝。此模式允許**限定範圍的配置**（Scoped Configuration），即 L2VNI 僅需配置在有端點連接的 VTEP 上，提高了多租戶部署的靈活性和擴展性。

### 端點移動性 (Endpoint Mobility)

EVPN 設計了優雅的機制來處理端點（如 VM）在 Fabric 內移動時的快速收斂和地址更新。

*   **序列號 (Sequence Number)：** BGP EVPN 透過在 **Route Type 2** 訊息中包含一個 **MAC 移動性擴展社群 (MAC mobility extended community)** 和遞增的序列號。當端點移動到新 VTEP 時，新 VTEP 會發送一個序列號遞增的 Route Type 2 更新，覆蓋舊 VTEP 的宣告。
*   **快速收斂：** 這種序列號機制避免了傳統網路中因 MAC/ARP 老化時間導致的服務中斷，無需等待舊路徑被撤銷，實現「即時」收斂。
*   **重複地址偵測：** 該機制也用於偵測意外配置的重複 MAC/IP 地址（Duplicate Endpoints），一旦在短時間內偵測到多次移動（例如 180 秒內移動 5 次），系統會啟動凍結計時器以避免網路不穩定。

### 虛擬埠通道 (vPC) 在 VXLAN BGP EVPN 中的應用

vPC（Multi-Chassis Link Aggregation, MC-LAG）用於實現 Layer 2 雙歸屬和設備冗餘。

*   **Anycast VTEP 概念：** 參與 vPC 的一對 VTEP 共享一個 **虛擬 IP 地址 (VIP)** 作為 Anycast VTEP。所有附屬於該 vPC 域的端點，其可達性（無論是 Route Type 2 還是 Route Type 5）都透過這個共享的 VIP 作為下一跳 (Next Hop) 進行宣告。
*   **流量轉發：** 從遠端 VTEP 發往該 Anycast VTEP VIP 的流量，將依賴底層路由網路的 ECMP 機制，平均分配給 vPC 對中的兩個成員。
*   **孤點端點 (Orphan Endpoints)：** 對於僅連接到 vPC 對中單一成員的孤點端點，若 ECMP 流量被導向到錯誤的 vPC 成員，流量將透過 vPC Peer Link 轉發到正確的成員，確保可達性。
*   **`advertise-pip` 功能：** 為了應對某些路由特殊情況（如南向子網或 DHCP Relay），可以啟用此功能。它允許 VTEP 使用其**單獨的物理 IP 地址 (PIP)** 來宣告 Route Type 5（IP 前綴路由），而 Route Type 2（主機路由）仍使用共享 VIP。

### 動態主機配置協定 (DHCP) 處理

在 DIPAG 環境中，DHCP 處理需要特殊調整，因為所有 VTEP 共享閘道 IP，可能導致 DHCP 響應無法返回正確的 VTEP。

*   **DHCP Relay 挑戰：** 預設情況下，DHCP Relay 會在 **GiAddr 欄位**中使用閘道 IP 地址。當 DHCP 伺服器響應時，可能會因為 Anycast IP 的存在而將響應路由到錯誤的 VTEP。
*   **解決方案：** 必須配置 DHCP Relay，使用 VTEP 上的 **唯一可路由 IP 地址** 來填充 GiAddr 欄位（例如使用 `ip dhcp relay source-interface` 命令）。
*   **DHCP 選項 82：** 由於 GiAddr 不再用於子網範圍選擇，需要同時配置 **DHCP Option 82**（通常使用 **Link Selection** 或 **Circuit-ID** 子選項），以便 DHCP 伺服器能夠確定正確的 IP 子網範圍來分配地址。

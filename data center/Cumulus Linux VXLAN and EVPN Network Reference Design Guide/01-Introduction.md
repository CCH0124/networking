## 概論 (Introduction)

在現代網路中，網路的簡易性、敏捷性和可擴展性至關重要。過去，應用程式的設計目的是為了在 L2 網域內擴展，這導致了像 Spanning Tree (STP) 這樣脆弱且效率低下的協定被廣泛使用。

乙太網路 VPN (EVPN) 是一種技術，允許 L2 網段透過 L3 網路進行分離。它是邊界閘道協定 (BGP) 的一個擴展，能夠在 L2 MAC 位址和 L3 IP 位址之間傳遞端點可達性資訊。

在資料中心，EVPN 實現了最佳的東西向 (east-west) 和南北向 (north-south) 流量轉發。它支援 L2 廣播、未知單播和多播 (BUM) 流量的整合路由和橋接 (IRB)。EVPN 的控制平面設計允許虛擬機器 (VM) 跨機架 (rack) 或跨網路移動。EVPN 也常與 VXLAN 一起運行，並可擴展 L2 子網路。

### 用於租戶的虛擬 L2 和 L3 EVPN (Virtual L2 and L3 EVPN for tenancy)

可以選擇在 L2、L3 或兩者上分割的網路。透過 L2 和 L3 端點可達性資訊，EVPN 支援整合式路由和橋接 (IRB) 的覆蓋網路 (overlays)。

### 關鍵使用案例 (Key Use Cases)

1.  **擴展存取層 (Scaling the access layer)**
    * 主動-主動 (Active-active) 的 L2 和 L3 多重路徑 (multihoming) 對高可用性至關重要。
    * 最佳化的東西向和南北向轉發。
2.  **擴展 L2 網路 (Extending layer 2 networks)**
    * 透過在所有存取交換器上分佈式託管主機 MAC 和 IPv4/IPv6 路由，並在存取交換器終端提供 ARP (位址解析協定) 和 ND (鄰居發現) 處理，最大限度地減少了傳輸量，同時避免了傳統的 STP。
3.  **全網路頻寬利用 (Full network bandwidth utilization)**
    * 在 EVPN VXLAN 作為存取層運行的情況下，網路可以實現最佳化的 ingress 路由和最短路徑橋接。EVPN 控制平面使 L2 擴展不再僅限於跨資料中心的實體機架或網路。

### 拓撲 (Topology)

本文件使用以下拓撲。

![](https://docs.nvidia.com/networking-ethernet-software/images/guides/VXLAN-EVPN-design-guide/topology.png)

### 基本術語 (Basic Terminology)

| 術語 | 定義 |
| :--- | :--- |
| **Leaf (葉)** | 也稱為存取交換器，伺服器連接到此交換器。伺服器和儲存設備連接到 Leaf 交換器。 |
| **Spine (脊)** | 也稱為聚合或骨幹交換器，Leaf 交換器連接到此交換器，形成存取層，為網路連接點提供服務。 |
| **Border Leaf (邊界葉)** | 也稱為邊界交換器或服務 Leaf。此交換器作為底層 (underlay) 和外部世界之間的劃界點。Border Leaf 負責宣告 VXLAN 可達性並將 L2 流量橋接到 L3。 |
| **Super Spine (超級脊)** | 有時稱為聚合交換器、列尾 (end-of-row) 交換器或資料中心核心交換器。 |

### 常見的資料中心架構 (Common Data Center Architectures)

在過去十年中，資料中心的規模不斷擴大；它們需要運行的應用程式與過去的應用程式截然不同。這導致了網路的設計和部署方式必須改變。資料中心現在面臨著伺服器到伺服器通訊 (東西向流量) 的巨大需求，這種流量規模大且延遲敏感。

傳統的標準三層式架構 (存取層、聚合層和核心層) 是為南北向流量設計的，這些流量進出資料中心。這種傳統設計存在網路冗餘、擴展性、L2 網域中的 TTL 欄位失效以及可靠性等缺點。相較之下，L3 網路更具彈性，因為它能隔離故障。從內部 VLAN 洩漏出來的廣播風暴可能會影響整個 L2 網域。雲端原生基礎設施需要一種網路拓撲，允許靈活性和隨路由增長的擴展性。

雲端原生資料中心基礎設施推動了稱為 CLOS 的網路拓撲。Charles Clos 設計了一種架構，讓建立一個網路，其規模不受限於單一設備的埠口數量，而是受限於連接交換器所需的互連數量。

### 兩層 Clos 架構 (Leaf-Spine)

圖 1 顯示了兩層 Clos (Leaf-Spine) 拓撲。綠色節點代表 Spine 交換器，黑色節點代表 Leaf 交換器。因此，該拓撲結構通常稱為 **Leaf-Spine 拓撲**。


Spine 交換器僅連接到 Leaf 節點，Leaf 節點僅連接到伺服器。每個 Leaf 節點都連接到每個 Spine 節點。

Spine 和 Leaf 拓撲是全連通的 (full-mesh)，因為任意兩個節點之間都存在多條路徑。這種多路徑增加了可用頻寬，並允許流量透過**等價多路徑 (ECMP)** 在路徑之間平均分配。

此架構允許透過兩種方式擴展網路：
1.  **橫向擴展 (Scale-out):** 增加更多 Spine 交換器以增加頻寬。
2.  **縱向擴展 (Scale-up):** 增加更高頻寬的介面卡和 200/400G 互連。

通常，伺服器連接到 Leaf 交換器的鏈路速度較低，而 Leaf 和 Spine 交換器之間則透過更高速度的鏈路互連。

## 綜合重點整理

這份文件主要在說明為什麼現代資料中心需要從**傳統三層架構**轉向 **Leaf-Spine (Clos) 架構**，並採用 **EVPN-VXLAN** 作為控制平面技術。

1.  **傳統架構的困境：**
    * **流量模式不符：** 傳統架構專為「南北向」（進出資料中心）流量設計。
    * **效能瓶頸：** 現代應用需要大量「東西向」（伺服器之間）通訊，傳統架構對此支援不佳。
    * **STP 問題：** 依賴 Spanning Tree (STP) 協定會導致鏈路被阻擋，浪費頻寬且網路收斂緩慢。

2.  **現代架構：Leaf-Spine (Clos 拓撲)**
    * **架構：** 分為兩層：**Leaf (葉)** 用於連接伺服器；**Spine (脊)** 用於連接所有 Leaf。
    * **規則：** Leaf 只連 Spine，Spine 只連 Leaf。
    * **核心優勢 (ECMP)：** 每個 Leaf 到達其他 Leaf 都有多條等價路徑 (ECMP)，所有鏈路都能被充分利用，**沒有埠口被阻擋**，大幅提升總頻寬。
    * **擴展性：** 擴展非常容易，增加頻寬只需增加 Spine 交換器 (橫向擴展)。

3.  **關鍵技術：EVPN (乙太網路 VPN)**
    * **用途：** EVPN 是一種**控制平面**技術，它使用 BGP 協定來傳遞 L2 (MAC) 和 L3 (IP) 的端點資訊。
    * **取代傳統 L2：** 它取代了 STP，解決了 L2 網路的各種弊病。
    * **主要優勢：**
        * **最佳化路由：** 實現 L2 和 L3 的最佳路徑轉發。
        * **靈活性：** 允許 L2 網路跨 L3 網路延伸 (例如透過 VXLAN 隧道)。
        * **減少廣播：** 具備 ARP/ND 抑制功能 (如上一個問題所述)，減少不必要的廣播封包。
        * **高可用性：** 支援 Active-Active 多重路徑。

總結來說，**Leaf-Spine** 提供了物理上的最佳拓撲，而 **EVPN** 提供了控制層面的最佳協定，兩者結合是現代資料中心網路的主流解決方案。

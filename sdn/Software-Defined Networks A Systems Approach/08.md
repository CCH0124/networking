這個章節不僅闡述了 SDN 第一個取得商業成功的應用案例，更重要的是，它揭示了如何將 SDN 的核心原則應用於伺服器端，從而徹底改變了資料中心的網路管理與安全模式。

### 總體概念：疊加網路 (Overlay) 與 SDN 原則的應用

從架構的角度來看，網路虛擬化最關鍵的特性在於它是一種**疊加 (overlay)** 技術。這意味著它可以在現有的、未經修改的實體 L2/L3 網路上運行，而無需底層交換器的任何配合。這種部署上的便利性是其早期能快速普及的關鍵因素。

然而，我們必須區分現代基於 SDN 的網路虛擬化與傳統的虛擬網路技術，如 VPNs 或 VLANs。傳統技術並未實現 SDN 的核心精神——**控制平面與資料平面的分離**。現代網路虛擬化的架構，主要歸功於 Nicira 團隊的開創性工作，它將 SDN 的核心原則——**控制平面集中化**與**資料平面分離**——應用於伺服器端的虛擬交換器 (virtual switches)。


### 1. 驅動網路虛擬化的挑戰 (The Challenges)

網路虛擬化的崛起，是為了解決現代資料中心，特別是雲端運算環境下所面臨的一系列嚴峻挑戰。

*   **伺服器虛擬化帶來的敏捷性差距**：隨著伺服器虛擬化技術的成熟，配置一台虛擬機器 (VM) 的時間從數天縮短到幾分鐘甚至幾秒。相較之下，傳統手動配置網路（如 VLAN、防火牆規則、NAT 等）的流程成為了整個基礎設施交付中的「長頸瓶 (long pole)」，嚴重拖慢了業務上線速度。
*   **VM 遷移 (Mobility) 的難題**：在傳統網路中，VM 的 IP 位址與其所在的實體子網路 (subnet) 緊密耦合。這導致 VM 遷移時面臨兩難：要麼只能移動到同一子網路下的其他伺服器，限制了資源利用效率；要麼需要更換 IP 位址，這會中斷 TCP 連線，甚至需要重啟應用程式。雖然有人提議擴大實體 L2 網路的範圍，但這在大規模使用 L3 互連的資料中心內不具備可擴展性。
*   **東西向流量 (East-West Traffic) 的興起**：現代資料中心的應用程式架構導致大量的流量是在伺服器之間橫向流動（東西向流量），而非進出資料中心（南北向流量）。為了高效支援這種流量模式，葉脊交換矩陣 (leaf-spine fabrics) 成為主流架構。網路虛擬化需要能在此類架構上有效運行。

為了解決這些問題，VL2 (Virtual Layer 2) 等早期方案提出了一個關鍵思想：**將虛擬機器使用的位址與實體網路使用的位址解耦**，從而解決了遷移問題。而 SDN 的出現，則為徹底解決網路配置的複雜性與敏捷性問題提供了最終的架構藍圖。

### 2. 核心架構 (The Architecture)

一個現代的網路虛擬化系統，其架構可以清晰地劃分為管理、控制與資料三個平面。

#### **資料平面 (Data Plane)**
*   **核心元件**：資料平面的核心是在每個伺服器 (hypervisor) 內部運行的**虛擬交換器 (Virtual Switch, vSwitch)**。最廣泛部署的開源 vSwitch 是 **Open vSwitch (OVS)**。
*   **關鍵機制：封裝 (Encapsulation)**：為了實現虛擬與實體位址空間的解耦，所有虛擬網路之間的封包都會被**封裝**。封裝會在原始封包（帶有 VM 的虛擬 IP 和 MAC 位址的**內部標頭**）之外，再加上一層**外部標頭**（帶有來源和目的 hypervisor 的實體 IP 位址）。常見的封裝協定有 VXLAN、NVGRE，以及更具擴展性的 **GENEVE**。GENEVE 的優勢在於其可變長度的選項欄位，允許在通道兩端傳遞額外的元數據 (metadata)，這對於軟體實現的功能演進至關重要。

![](https://sdn.systemsapproach.org/_images/Slide45.png) Encapsulation decouples virtual network addresses from physical network.

*   **性能優化**：由於 vSwitch 位於所有流量的路徑上，其性能至關重要。優化手段包括：
    *   **DPDK**：一套函式庫，可顯著提升 OVS 在 x86 平台上的封包轉發性能。
    *   **SmartNICs**：將部分或全部 vSwitch 功能**卸載 (off-load)** 到智慧網卡上執行，以獲得硬體加速的性能，P4 語言正成為編寫這些卸載功能的趨勢。
    *   **硬體閘道**：在需要極高性能的場景，可使用支援 VXLAN 等功能的裸機交換器作為虛擬到實體的閘道。

#### **管理平面 (Management Plane)**
*   **功能**：管理平面負責接收來自雲端管理平台（如 OpenStack, Kubernetes）或管理員的 API 請求。這些請求描述了虛擬網路的**期望狀態 (desired state)**，例如「建立一個 L2 子網路」、「將 VM A 連接到子網路 X」或「對 VM B 的流量應用防火牆策略 P」。

![](https://sdn.systemsapproach.org/_images/Slide46.png) The Three Planes of a Network Virtualization System.

*   **狀態儲存**：這些期望狀態會被儲存在一個資料庫中。

#### **控制平面 (Control Plane)**
*   **核心職責**：控制平面是整個系統的大腦。它的核心任務是**持續地將網路的實際狀態與期望狀態進行核對 (reconcile)**。
*   **工作流程**：
    1.  控制平面從資料平面（vSwitches）收集**已發現狀態 (discovered state)**，例如 VM 目前在哪個實體伺服器上。
    2.  它將已發現狀態與管理平面儲存的期望狀態進行比較。
    3.  如果兩者不匹配（例如，一個 VM 遷移到了新的伺服器），控制平面會重新計算所需的變更，並將這些變更作為**控制指令 (control directives)**（例如，新的 OpenFlow 規則）推送給相關的 vSwitches。
    4.  這個閉環控制確保了即使在 VM 動態遷移的情況下，虛擬網路的策略和連接性也能始終保持正確。

### 3. 架構優勢與創新應用

這種基於 SDN 的架構不僅解決了最初的挑戰，還催生了全新的網路服務模式與安全理念。

#### **分散式服務 (Distributed Services)**
這是網路虛擬化帶來的一項革命性變革。傳統上，防火牆、負載平衡器等網路功能是以實體設備形式部署，形成網路的**阻塞點 (choke point)**。所有需要處理的流量都必須繞路經過這些設備，造成效率低下、髮夾彎流量 (hairpinning) 以及單點性能瓶頸。

![](https://sdn.systemsapproach.org/_images/Slide47.png) A conventional firewall (not distributed).

網路虛擬化則允許將這些功能以軟體形式**分散地**實現在每個 hypervisor 的 vSwitch 中。
*   **優勢**：
    *   **效率**：流量總是在實體網路的最短路徑上傳輸，無需繞道。
    *   **消除瓶頸**：沒有集中的硬體瓶頸，服務能力隨伺服器數量的增加而水平擴展。
    *   **同機通訊優化**：同一台伺服器上兩個 VM 之間的通訊，甚至無需離開伺服器即可完成防火牆等策略處理。

![](https://sdn.systemsapproach.org/_images/Slide48.png) A distributed firewall.


#### 1. 虛擬網路封裝 (Virtual Network Encapsulation)

封裝是實現網路虛擬化的基石，其核心目標是將虛擬網路的位址空間與實體網路的位址空間徹底解耦。這使得虛擬機器 (VM) 可以在資料中心內自由遷移，而無需更改其 IP 位址。

#### **GENEVE：為軟體定義而生的可擴展封裝協定**

雖然早期的 VXLAN 協定獲得了廣泛關注，但它並非最終解答。經過多年的實踐與標準化努力，業界最終催生出一個更為先進與靈活的封裝協定——**GENEVE (Generic Network Virtualization Encapsulation)**。

*   **設計核心：可擴展性 (Extensibility)**
    *   GENEVE 最顯著的特點是其**可變長度的選項 (variable length options)** 欄位。這個設計巧妙地平衡了軟體與硬體的需求：對於軟體實現的 vSwitch 而言，它提供了極大的靈活性，可以隨時為新的網路功能增加所需的元數據 (metadata)；對於硬體實現（如 SmartNIC 或裸機交換器）而言，這些選項可以被高效處理，甚至在不需要時直接忽略。
    *   這個設計汲取了早期系統的經驗教訓：像 VXLAN 這樣的固定標頭空間有限，不足以在通道 (tunnel) 的兩端傳遞日益複雜的虛擬網路元數據。
    *   **實際應用範例**：一個常見的元數據用途是傳遞封包的**邏輯來源埠 (logical source port)**，以便通道的接收端可以基於這個資訊來執行相應的處理策略。

*   **根本價值**：GENEVE 的設計理念體現了一個深刻的認知——虛擬網路的功能是由軟體驅動並持續演進的。因此，底層的封裝協定絕不能成為限制上層功能創新的瓶頸。

![](https://sdn.systemsapproach.org/_images/Slide49.png) GENEVE Header Format.

#### 2. 虛擬交換器 (Virtual Switches)

虛擬交換器 (vSwitch) 是網路虛擬化資料平面的核心執行元件，它運行在每台伺服器的 hypervisor 或容器主機中。vSwitch 功能集的豐富程度，直接決定了虛擬網路能否忠實地重現實體網路的所有特性。

##### **Open vSwitch (OVS)：業界標準的開源 vSwitch**

OVS 是目前部署最廣泛的開源 vSwitch，被用於眾多商業及開源系統中，如 VMware NSX 和 OVN。

*   **架構與控制** (如圖 48 所示)：
    *   **控制平面介面**：OVS 像許多硬體交換器一樣，使用 **OpenFlow** 協定來接收來自控制平面的程式化指令。
    *   **配置平面介面**：OVS 使用一個獨立的通道，即 **OVSDB (Open vSwitch Database) 協定**，來接收配置資訊。從功能上看，OVSDB 的角色類似於硬體交換器世界中的 gNMI/gNOI。
    *   **OVSDB 的雙重角色**：OVSDB 不僅僅是一個用於訪問設定資料庫的 RPC 協定，它本身也可以指代該資料庫。作為資料庫，它有自己的 schema（類似於硬體世界的 OpenConfig）；作為協定，它使用 JSON 格式（類似於 gNMI 使用 protobufs）。OVSDB 的應用已超越 OVS 本身，成為一種通用的網路轉發狀態表示方式。

*   **資料平面設計與優勢**：
    *   **性能**：OVS 透過一系列優化來提升性能，其中最著名的是在核心 (kernel) 中實現了一個**快速路徑 (fast-path)**，利用流緩存 (flow cache) 來處理同一個流中第一個封包之後的所有封包。
    *   **靈活性**：一個流的第一個封包會被送到用戶空間的守護行程 (`ovs-vswitchd`) 處理。由於這部分的流表是在軟體中實現的，其**數量幾乎沒有限制**，這與受硬體資源限制的實體交換器形成鮮明對比，也正是這種靈活性賦予了網路虛擬化實現複雜功能的能力。
    *   **跨平台支援**：OVS 不僅可用於 VM 環境，也同樣適用於容器環境，能夠橋接同一主機或不同主機上的容器，並支援 VM 與容器混合通訊的虛擬網路。

![](https://sdn.systemsapproach.org/_images/Slide50.png) Open vSwitch Functional Blocks

#### 3. 性能優化 (Performance Optimizations)

由於 vSwitch 位於所有進出 VM/容器 流量的路徑上，其性能至關重要。業界發展出了多種技術來應對性能挑戰。

*   **DPDK (Data Plane Development Kit)**
    *   **原理**：這是一套專為 Intel x86 平台開發的函式庫，旨在提升封包處理等資料移動操作的性能。其技術核心包括批次處理封包、避免內文切換 (context switches) 等。
    *   **效果**：將 DPDK 應用於 OVS，可以顯著提升其性能。在虛擬到實體閘道 (Virtual-to-Physical Gateway) 這種純轉發場景中，OVS-DPDK 在高階 Intel 處理器上能達到 **16 Mpps** (每秒百萬封包) 以上的轉發率，而單純的 OVS 約為 1 Mpps。

*   **SR-IOV (Single Root IO Virtualization)**
    *   **原理**：這是一項硬體功能，允許單張實體網卡 (NIC) 對 hypervisor 呈現為多張虛擬網卡，每張虛擬網卡有獨立的資源。VM 可以直接綁定一張虛擬網卡，從而完全繞過 hypervisor 進行 I/O 操作。
    *   **與網路虛擬化的矛盾**：雖然 SR-IOV 提升了 I/O 性能，但它也**繞過了 vSwitch**。這與網路虛擬化的核心價值背道而馳，因為網路虛擬化的靈活性與豐富功能正是來自於可程式化的 vSwitch。因此，SR-IOV 對於網路虛擬化場景並不是一個有用的方法。

*   **SmartNICs (智慧網卡)**
    *   **概念**：這是一種將傳統上由伺服器 CPU 執行的部分功能**卸載 (off-load)** 到網卡上執行的技術。
    *   **應用**：隨著 SmartNICs 的能力越來越強，可以將部分甚至全部的 vSwitch 功能卸載到網卡上，以換取性能提升。P4 語言正成為編寫這些卸載功能的一種趨勢。
    *   **核心權衡**：這裡存在一個經典的**性能與靈活性的權衡 (trade-off)**。SmartNICs 的資源仍然比通用 CPU 有限，因此卸載功能意味著犧牲一定的靈活性。

*   **硬體閘道 (Hardware Gateways)**
    *   **概念**：在對性能要求極高的場景，可以利用支援 VXLAN 等功能的專用裸機交換器來代替軟體 vSwitch 實現閘道功能。
    *   **最終權衡**：這再次回到了**靈活性與性能的權衡**上。在大多數商業網路虛擬化部署中，基於通用硬體的軟體方案因其更高的靈活性而受到青睞。未來的挑戰在於識別出那些相對固定且普遍適用的功能子集，將它們實作在硬體中以獲得最大的性能效益。

#### **微分段 (Microsegmentation)**
網路虛擬化使得以程式化方式、低成本地創建大量隔離的虛擬網路變得極為簡單，這催生了**微分段**這一安全最佳實踐。

*   **傳統模式**：傳統安全模型是基於區域 (zone) 的邊界防火牆，區域內部的伺服器（即使它們屬於不同應用）可以自由通訊，這為攻擊的橫向移動提供了溫床。
*   **微分段模式**：可以為單一應用，甚至應用內部的不同層級（如 Web 層、應用層、資料庫層）創建專屬的、精細定義的虛擬網路（即微區段）。策略可以精確到「Web 層的 VM 只能透過特定埠訪問應用層的 VM，但 Web 層的 VM 之間禁止互相通訊」。這種過去因配置極其複雜而無法實現的策略，在網路虛擬化中變得輕而易舉。
*   **影響**：微分段顯著減少了攻擊面，是實現「零信任 (zero-trust)」網路安全的基礎。

### 4. 實作系統範例：OVN (Open Virtual Network)

本章節以 OVN 作為一個具體的開源實作範例來說明上述架構。

*   **架構**：OVN 是 OVS 的一套增強功能，其管理和控制平面基於 OVSDB 資料庫。
*   **混合式控制平面**：OVN 的一個顯著特點是其**混合式 (hybrid)** 控制平面。它包含一個集中的 `ovn-northd` 元件和一個分散在每個 hypervisor 上的 `OVN controller` 元件。`ovn-northd` 負責將高階的邏輯網路配置（來自北向資料庫）轉換成與實體位置無關的**邏輯流表 (Logical Flows)**，並儲存在南向資料庫中。而每個 hypervisor 上的 `OVN controller` 則負責發現本地 VM 的實體位置，並結合南向資料庫中的邏輯流表與其他 hypervisor 回報的位置資訊，計算出最終需要安裝到本地 OVS 實例中的具體 OpenFlow 規則。
*   **設計動機**：這種將控制平面部分功能分散的設計，是為了應對早期純集中式控制器在處理海量流表時遇到的擴展性挑戰。它在保留**邏輯上集中控制**（提供單一 API 入口）的同時，提升了整體的系統擴展性。


![](https://sdn.systemsapproach.org/_images/Slide51.png) OVN High-level Architecture.


總結來說，網路虛擬化是 SDN 理念在實務中一次教科書級別的成功應用。它完美地體現了透過分離控制與資料平面、集中化網路智慧，不僅能解決現有問題，更能催生出如分散式服務和微分段這樣全新的、更優越的網路架構範式。它證明了 SDN 是一種強大的系統方法，能夠為複雜的網路環境帶來前所未有的敏捷性、可擴展性與安全性。

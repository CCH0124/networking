本章節的核心在於展示如何利用 SDN 原則與一系列開源軟體堆疊，建構一個具備產品級功能、高可用性與可擴展性的資料中心交換矩陣 (switching fabric)。

### 總體架構：以 SD-Fabric/Trellis 為例的 SDN 實踐

本章節以一個名為 SD-Fabric（在另一版本中稱為 Trellis）的 exemplar 實作為範例，它是一套運行在網路作業系統 ONOS 之上的控制應用程式集合。

從架構師的角度來看，這個設計的關鍵特性在於其徹底的「解構 (disaggregation)」精神：

*   **硬體層**：完全採用裸機交換器 (bare-metal switches)，這些交換器可以是固定功能管線 (fixed-function pipelines) 或可程式化管線 (programmable pipelines)。
*   **軟體層**：交換器上運行精簡的交換器作業系統 (Switch OS)，而整個網路的智慧與控制邏輯則集中在 ONOS 與其上的 SD-Fabric/Trellis 控制應用程式中。
*   **拓撲**：主要支援資料中心常見的葉脊網路拓撲 (leaf-spine topology)，用於互連多個機櫃的伺服器，同時也支援多站點部署 (multi-site deployments)。

這個架構的目標不僅是複製傳統網路功能，更是要透過 SDN 的集中式控制與可程式化能力，來提升網路的彈性、可擴展性與自動化程度。

### 1. 核心功能集 (Feature Set)

一個產品級的網路解決方案，首要任務是必須能夠完整重現並超越傳統網路的功能、穩定性與擴展性。SD-Fabric/Trellis 在這方面提供了全面的支援。

#### **L2/L3 連接性**
*   **L2 功能**：SD-Fabric 支援 VLANs，能基於 VLAN ID 進行轉發。它還支援 Q-in-Q（雙層 VLAN 標籤），這在接取網路 (access networks) 中尤其重要，可用於隔離不同服務等級的流量。此外，它能夠在 L3 矩陣之上建立 L2 隧道。
*   **L3 功能**：支援 IPv4 和 IPv6 的單播 (unicast) 與多播 (multicast) 路由。值得注意的是，其多播實現並非運行傳統的 PIM 協定，而是採用集中式的多播樹建構，但仍支援終端主機使用 IGMP 協定加入或離開群組。同時，它也完整支援 ARP (IPv4) 和 NDP (IPv6) 的位址解析，以及 DHCPv4/v6 的中繼功能。

#### **高可用性 (High Availability)**
這是任何大型網路設計的基石。SD-Fabric 透過多種技術組合來確保在鏈路或交換器故障時的服務持續性：
*   **雙歸屬 (Dual-homing)**：每台伺服器都連接到一對 ToR (Top-of-Rack) 交換器（即 Leaf 交換器）。
*   **鏈路聚合 (Link Bonding)**：伺服器作業系統層級實現 active-active 模式的鏈路綁定。
*   **ECMP (Equal-Cost Multipath)**：
    1.  每個 Leaf 交換器到單一 Spine 交換器的多條鏈路會被設定為一個 ECMP 群組。
    2.  每個 Leaf 交換器到所有 Spine 交換器的鏈路集合也構成一個 ECMP 群組。
    ECMP 的作用是將封包負載平衡到多條等價路徑上，這不僅提升了頻寬，也提供了自動的故障恢復機制——當一條鏈路失效時，流量會自動分配到群組中其餘的鏈路上。SD-Fabric 的控制應用程式會基於全域拓撲資訊，將這些 ECMP 埠群組的設定推送到每一台交換器中。
*   **控制平面容錯**：SD-Fabric 運行的 ONOS 本身就是一個分散式系統，通常會部署 3 到 5 台伺服器來實現高可用性。

![](https://sdn.systemsapproach.org/_images/Slide31.png) High availability through a combination of dual-homing, link bonding, and ECMP groups.

#### **可擴展性 (Scalability)**
SD-Fabric 的擴展能力直接受益於 ONOS 的分散式核心架構。在一個包含 2 台 Spine 和 8 台 Leaf 交換器的配置中，它已證明能夠支援高達 12 萬條路由和 25 萬條流規則 (flows)。

### 2. 核心轉發策略：區段路由 (Segment Routing)

了解了 SD-Fabric *做什麼* 之後，接下來的重點是它 *如何做*。其核心轉發策略基於**區段路由 (Segment Routing, SR)**。

*   **基本原理**：SR 是一種來源路由 (source routing) 的形式，它將端到端的路徑視為一系列「區段」(segments) 的組合。在 SD-Fabric 的實踐中，它利用了 MPLS (Multi-Protocol Label Switching) 的轉發平面，透過標籤交換 (label-switching) 來引導封包穿越不同的區段。
*   **Leaf-Spine 中的應用**：在 Leaf-Spine 拓撲中，路徑被簡化為兩個固定的區段：**leaf-to-spine** 和 **spine-to-leaf**。

**轉發流程範例** (如圖 40 / 38 所示)：
假設主機 1 (10.0.1.1) 要傳送封包給主機 2 (10.0.2.1)。
1.  封包到達其連接的 Leaf 1 交換器。
2.  Leaf 1 根據目的 IP 位址 (10.0.2.1) 判斷封包需要穿越 Fabric 到達 Leaf 2 所在的子網路 (10.0.2/24)。
3.  Leaf 1 在封包上**推送 (push)** 一個 MPLS 標籤，該標籤值對應於目的 Leaf 交換器，在此例中為 `102`。
4.  由於 ECMP 的存在，Leaf 1 可以將這個帶有標籤的封包轉發給任意一台 Spine 交換器。
5.  Spine 交換器收到封包後，只根據 MPLS 標籤 `102` 進行匹配，將標籤**彈出 (pop)**，然後將原始封包轉發給 Leaf 2。
6.  Leaf 2 收到無標籤的封包後，再根據目的 IP 位址將其轉發給最終的主機 2。

從這個流程可以看出，SR 是一種高度風格化 (stylized) 的方法。SD-Fabric 會預先計算好所有可能的路徑，並將對應的 match/action 規則安裝到交換器中，而負載平衡的複雜性則被委派給 ECMP。

![](https://sdn.systemsapproach.org/_images/Slide32.png) Example of Segment Routing being used to forward traffic between a pair of hosts.

### 3. 路由與多播管理

SD-Fabric/Trellis 充分利用了 ONOS 提供的 **Route** 和 **Mcast** 服務，但實現方式與傳統網路截然不同。

*   **集中式計算**：它不運行 OSPF 或 PIM 這類分散式協定來學習路由或建構多播樹。相反，它基於全域的網路資訊直接計算出正確的轉發路徑與多播樹，然後將這些結果推送到 ONOS 的服務中。這種做法之所以可行，是因為 SD-Fabric 施加了一個簡化約束：每個機櫃對應一個獨立的 IP 子網路。
*   **路由來源**：
    *   **STATIC**：通常由 SD-Fabric 根據其分配給每個機櫃的 IP 前綴自動插入。
    *   **FPM (Forwarding Plane Manager)**：這是一個 ONOS 服務，用於學習外部路由。它透過與本地運行的 Quagga BGP 伺服器對接，從外部 BGP 鄰居那裡獲取路由資訊，並將其添加到 Route 服務中。
*   **多播管理**：SD-Fabric 提供了一個程式化的介面（可透過 RESTful API 或 CLI 調用），讓網路營運商可以定義多播樹，例如添加或刪除來源 (sources) 和接收端 (sinks)。此外，它也能夠攔截終端用戶發出的 IGMP 訊息，動態地管理多播群組成員，這在 IPTV 等應用中非常實用。

### 4. 客製化轉發平面 (Customized Forwarding)

本章節的最後一部分，揭示了 SDN 的終極潛力：當我們明確了網路需要的功能後，可以回頭去客製化底層的轉發平面，以達到最佳的效能與契合度。

*   **`fabric.p4` 的誕生**：隨著 SD-Fabric/Trellis 的演進，一個名為 `fabric.p4` 的 P4 程式應運而生。它是一個專為 SD-Fabric 功能集量身打造的客製化轉發管線。這證明了將網路視為一個可程式化平台，能夠使其持續且快速地演進。

*   **`fabric.p4` 的設計特點**：
    1.  **簡化自 OF-DPA**：它的設計鬆散地基於 Broadcom 的 OF-DPA 管線，因為最初的實作是基於 Tomahawk 晶片的交換器。但 `fabric.p4` 移除了 SD-Fabric/Trellis 不需要的功能表，使其更易於控制。
    2.  **與 ONOS FlowObjective API 對應**：`fabric.p4` 的邏輯管線設計旨在模仿 ONOS 的 FlowObjective API，也就是 **Filtering -> Forwarding -> Next** 的三階段流程。這大大簡化了從控制平面意圖到資料平面 P4Runtime 操作的映射過程。
    ![](https://sdn.systemsapproach.org/_images/Slide40.png) Logical pipeline supported by fabric.p4, designed to parallel the Filtering, Forwarding, and Next stages of the FlowObjective API.
    3.  **可配置與可擴展**：`fabric.p4` 透過 C 語言風格的預處理器條件 (`#ifdefs`) 實現了高度的可配置性，允許在編譯時選擇性地加入額外的功能模組。

*   **VNF Off-loading**：`fabric.p4` 支援的一些擴展功能是所謂的 **VNF 卸載 (VNF off-loading)** 的絕佳範例。VNF (虛擬網路功能) 通常運行在通用伺服器的虛擬機中，而卸載則是將這些功能直接在交換器的轉發管線中用 P4 重新實現。這樣做可以顯著提升效能，因為封包無需繞道伺服器處理。
    *   **UPF/SPGW**：為 4G/5G 行動網路提供支援，例如處理 GTP 隧道封裝/解封裝。
    *   **BNG**：為光纖到府 (FTTH) 提供支援，例如處理 PPPoE 終端。
    *   **INT (Inband Network Telemetry)**：增加網路狀態收集與遙測輸出的指令。

總而言之，Leaf-Spine Fabric 這一章節不僅僅是描述一個網路拓撲，更是 SDN 系統化方法的一個完整縮影：從定義上層應用所需的功能集，到底層轉發平面的客製化，所有環節都透過開放的 API 和可程式化的元件串連起來，最終實現了一個高效、可靠且可持續演進的現代網路架構。

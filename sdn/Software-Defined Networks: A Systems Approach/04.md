### Chapter 4: Bare-Metal Switches 詳細重點整理

#### 1. 裸機交換器 (Bare-Metal Switch) 的概念與組成

裸機交換器的核心理念是**硬體標準化與商品化**，這與過去數十年來個人電腦 (PC) 產業的發展歷程極為相似。如同我們可以自行組裝一台 PC，現在也可以透過**開放運算計畫 (Open Compute Project, OCP)** 提供的開放硬體規格，打造一台高效能交換器，或是向 EdgeCore、Delta 等廠商購買符合 OCP 規範的預組裝交換器。

一台典型的裸機交換器主要由以下幾個商品化元件構成：

*   **網路處理單元 (Network Processing Unit, NPU)**：這是交換器的核心，通常是一顆商用矽晶片 (merchant silicon switching chip)，專為高速解析封包標頭與制定轉送決策而優化。其處理能力以 Tbps (Terabits-per-second) 為單位，當前最先進的晶片已達到 25.6 Tbps 的吞吐量。NPU 內部包含用於暫存封包的 SRAM 記憶體，以及執行一系列 (Match, Action) 操作的 ASIC 轉送管線。值得注意的是，這裡的 NPU 趨勢是朝向兼具高效能與高彈性的可程式化特定領域處理器發展，類似於 GPU 或 TPU 的概念。
*   **通用處理器 (General-Purpose Processor)**：通常是一顆 x86 晶片，負責控制 NPU。在 SDN 架構中，這顆 CPU 不再運行傳統的 BGP、OSPF 等控制平面協定，而是運行**交換器作業系統 (Switch OS)**。Switch OS 會對外提供 API，讓遠端的網路作業系統 (Network OS) 能夠控制資料平面。
*   **標準化周邊元件**：
    *   **可插拔光模組 (Pluggable Transceivers)**：遵循 SFP+ 等標準化規格，處理各種媒體存取細節（如 40-Gigabit Ethernet）與光學轉換。
    *   **ONIE (Open Network Install Environment)**：這是一種標準化的 BIOS 韌體，負責裸機交換器的配置與啟動，讓我們可以在其上安裝選擇的交換器作業系統。

![](https://sdn.systemsapproach.org/_images/Slide10.png) High-Level schematic of a bare-metal switch.

這個架構的核心優勢在於**解耦 (decoupling)** 與**商品化 (commoditization)**，打破了傳統網路設備軟硬體垂直整合的封閉模式。

#### 2. 封包轉送管線 (Forwarding Pipeline)

為了達到 Tbps 等級的線速 (line-rate) 轉送，高速交換器採用**多級管線 (multi-stage pipeline)** 來處理封包。這種設計允許交換器同時處理多個封包的不同階段（例如，當 Stage 2 正在處理封包 A 時，Stage 1 已經可以開始處理封包 B），從而實現極高的總吞吐量。

NPU 轉送管線主要分為兩大類：

*   **固定功能管線 (Fixed-Function Pipeline)**：管線的每個階段都硬體寫死了，只能處理特定的、已知的協定標頭。
*   **可程式化管線 (Programmable Pipeline)**：管線的每個階段都可以透過軟體動態編程，來定義要辨識、匹配和處理哪些標頭欄位。

本章節的重點在於更通用、更具彈性的可程式化管線。

#### 3. PISA(Protocol Independent Switching Architecture): 可程式化管線的基礎架構

**協議無關交換架構 (Protocol Independent Switching Architecture, PISA)** 是可程式化管線的通用架構模型，主要包含三個核心組件：

1.  **解析器 (Parser)**：負責識別封包中的標頭。它被編程來定義要從封包中提取哪些標頭欄位，以及它們在封包中的位置。解析器的運作方式類似一個狀態機，從 `start` 狀態開始，根據標頭中的欄位值（如 EtherType）轉換到下一個狀態（如 `parse_ipv4`），並在過程中提取標頭資料。
2.  **匹配-動作單元序列 (Sequence of Match-Action Units)**：這是管線的核心處理邏輯。每個單元都可以被編程來匹配一個或多個由解析器提取出的標頭欄位，並執行相應的動作。
    *   **匹配 (Match)**：通常由 SRAM（用於精確匹配）和 TCAM（用於萬用字元匹配）組合實現。TCAM 因其支援萬用字元（例如 `10*1`）而更昂貴且耗電，因此在軟體設計上應盡可能避免非必要的萬用字元匹配。
    *   **動作 (Action)**：由 ALU 執行，可執行的操作包括修改標頭欄位（如遞減 TTL）、推入/彈出標籤 (VLAN, MPLS)、更新計數器、設定元資料等。
3.  **解構器 (Deparser)**：在封包被轉送出去之前，將記憶體中經過修改的標頭欄位重新序列化，建構成最終的封包格式。

![](https://sdn.systemsapproach.org/_images/Slide11.png) High-level overview of PISA’s multi-stage pipeline.

此外，管線中還存在**元資料 (Metadata)**，用於攜帶封包的附加資訊（如來源埠、時間戳）或跨封包的流狀態（如計數器），這些元資料也可被 Match-Action 單元讀寫和匹配。

#### 4. P4: 編程資料平面的語言

直接對 PISA 的各個組件進行編程就像寫組合語言一樣繁瑣。**P4** 是一種高階的、領域特定的語言，專門用來描述封包處理管線的行為。P4 的語法類似 C 語言，但移除了迴圈、指標等不適用於硬體管線的結構。

開發者使用 P4 撰寫程式（例如 `forward.p4`），定義所需的轉送邏輯（如 L2 匹配 -> IPv4 路由 -> ACL 過濾），然後由 P4 編譯器將其轉換為底層 NPU 的低階指令，並將邏輯分配到 PISA 的物理階段中，這個過程類似於傳統編譯器進行的暫存器分配。

![](https://sdn.systemsapproach.org/_images/Slide12.png) Depiction of the desired forwarding behavior (as specified by a pictorial representation of a P4 program) mapped onto PISA.

#### 5. 管線抽象化：實現控制器與硬體解耦

不同廠商的交換晶片擁有不同的物理管線。為了讓控制平面的應用程式能夠跨不同硬體運作，我們需要一個**抽象的、標準的邏輯管線模型 (Abstract/Logical Pipeline)**。

*   **架構模型 (`arch.p4`)**: 這個邏輯管線本身也是用 P4 來定義的，通常以一個 P4 標頭檔的形式存在（如 `v1model.p4`、`psa.p4`）。它扮演著開發者的 P4 程式 (`forward.p4`) 與 P4 編譯器之間的**合約 (contract)**，定義了可用的 P4 可程式化區塊、介面以及每個階段的能力。
*   **主流的架構模型**:
    *   **V1Model**: 這是目前業界最廣泛使用的模型。它的結構相對簡單，包含了 Parser、Checksum Verification、Ingress Processing、Egress Processing、Checksum Update 和 Deparser 等可程式化區塊。P4 開發者實際上是根據 `v1model.p4` 提供的模板來填充程式碼。它之所以被廣泛採用，關鍵在於交換器廠商為其提供了將此模型映射到自家 ASIC 的編譯器後端。
        ![](https://sdn.systemsapproach.org/_images/Slide22.png) V1Model used in practice to abstract away the details of different physical forwarding pipelines. Developers write P4 to this abstract architectural model.
    *   **PSA (Portable Switch Architecture)**: P4 聯盟推出的一個更理想化的模型，目標是實現像 Java 虛擬機 (JVM) 一樣的「一次編寫，到處運行」(write-once-run-anywhere)。它比 V1Model 更複雜，明確區分了 Ingress 和 Egress 處理，並將 Traffic Manager（負責排隊、調度）作為一個可配置的固定功能階段。然而，由於缺乏廠商的編譯器後端支援，PSA 目前仍主要停留在紙面上。
    *   **TNA (Tofino Native Architecture)**: 這是 Barefoot (現為 Intel) 為其 Tofino 系列可程式化晶片定義的廠商特定架構模型。它選擇不遵循通用模型，目的是為了能充分暴露其晶片獨有的、具差異化的功能（例如封包加解密 externs）。

![](https://sdn.systemsapproach.org/_images/Slide13.png) P4 architecture known as the Portable Switch Architecture (PSA). Includes the generic `arch.p4` as the architecture model spec, but for PSA this would be replaced by `psa.p4`.

這就帶來一個重要的權衡：開發者是選擇一個**通用架構模型（如 V1Model）以獲得跨硬體的移植性**，還是選擇一個**原生架構模型（如 TNA）以利用特定晶片的獨有功能**。

#### 6. 固定功能管線及其抽象化

儘管可程式化管線是未來的趨勢，但固定功能晶片目前仍佔據市場主導地位。為了將它們整合進 SDN 生態系統，同樣需要抽象層：

*   **OF-DPA (OpenFlow—Data Plane Abstraction)**: 由 Broadcom 為其 Tomahawk 等固定功能晶片提供的硬體抽象層。它定義了一個固定的邏輯管線（包含 VLAN 表、MAC 表、IP 路由表等），並提供 API 讓上層的 OpenFlow Agent 能夠安裝流表規則。從概念上講，OF-DPA 的功能約等於一台可程式化交換器在載入了實現標準 L2/L3 功能的 P4 程式（如 `switch.p4`）後的狀態。

![](https://sdn.systemsapproach.org/_images/Slide14.png) Logical fixed-function pipeline defined by OF-DPA

*   **SAI (Switch Abstraction Interface)**: 由 OCP 推動的、一個跨廠商的社群標準。由於需要相容多家廠商的晶片，SAI 定義的功能集合通常是各家都支援的「最小公分母」。

#### 7. 總結與比較：SDN 開啟的創新之門

本章節揭示了從底層 ASIC 到上層控制平面的多層抽象堆疊（如 Figure 26 所示）。無論是可程式化還是固定功能管線，都需要一個抽象層（SDK 或 P4 架構模型）和一個邏輯管線定義。

*   **對於固定功能管線**：邏輯管線是由規格（如 OF-DPA, SAI）定義的。
*   **對於可程式化管線**：邏輯管線是由 P4 程式（如 `fabric.p4`）定義的，而這個程式是基於某個 P4 架構模型（如 `v1model.p4`）編寫的。

這種複雜性是值得的，因為 SDN 和 P4 將過去隱藏在專有設備中的硬體複雜性開放出來，使得創新成為可能。我們不再受限於固定功能的硬體。如果需要一個網路新功能，開發者現在可以同時撰寫控制平面的應用程式和資料平面的 P4 程式，將其載入到 SDN 堆疊中，實現端到端的創新。這是與幾年前只能修改路由協定軟體，卻無法改變硬體轉送行為的時代相比，一個巨大的進步。

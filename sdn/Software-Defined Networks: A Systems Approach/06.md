
網路作業系統 (Network Operating System, NOS) 是 SDN 架構中的大腦，它從單一交換器的本地視角提升到對整個網路的全域視角。我們可以將 NOS 視為一個水平擴展的雲端應用程式，其內部由多個鬆散耦合的子系統構成，類似於微服務架構，並包含一個可擴展且高可用的鍵值儲存 (key/value store)。本章節以 ONOS (Open Network Operating System) 作為參考實作，來闡述 NOS 的核心架構與設計理念。
以下是本章節的重點整理：

### 1. ONOS 整體架構 (Architecture)

ONOS 的架構設計高度模組化，主要分為三個層次，使用者可以根據部署需求選擇性地組態所需模組。

*   **北向介面 (Northbound Interfaces, NBI)**：應用程式透過 NBI 來獲取網路狀態 (例如：拓撲圖、攔截網路封包) 並控制資料平面 (例如：透過 FlowObjective API 編程轉發行為)。NBI 的範圍非常廣泛，涵蓋了網路的組態 (gNMI)、操作 (gNOI) 與控制 (Topology API, FlowObjective API)，確保所有對底層硬體的存取都由 ONOS 居中協調。
*   **分散式核心 (Distributed Core)**：負責管理全域網路狀態，並在狀態變更時通知相關應用程式。其核心內部是一個名為 Atomix 的可擴展鍵值儲存系統。
*   **南向介面 (Southbound Interface, SBI)**：由一系列外掛程式 (plugins) 組成，包含共用的協定函式庫和特定於裝置的驅動程式。

這個架構有幾個值得注意的關鍵設計：
1.  **抽象至具體的對應**：ONOS 的核心職責是將控制應用程式所期望的抽象網路行為 (例如：高階的 Intents 或與 pipeline 無關的 Flow Objectives)，轉換成需要傳達給網路中每台交換器的具體指令。
2.  **雙向資訊流**：資訊不僅由上而下（應用程式控制網路），也由下而上流動。南向外掛程式會將底層網路的資訊 (如裝置發現、鏈路品質、攔截的封包等) 傳遞給 ONOS 核心。
3.  **模糊的邊界**：ONOS 上的應用程式與服務可以層層堆疊，例如一個零接觸配置 (Zero-Touch Provisioning, ZTP) 應用可以運行在 ONOS 之上，提供自動化配置服務。這也凸顯了 ONOS 與傳統作業系統的不同：它沒有一個明確區分核心與使用者空間的系統呼叫介面，所有元件目前在單一的信任域中運作。

![](https://sdn.systemsapproach.org/_images/Slide26.png) Three-layer architecture of ONOS, hosting a set of control applications


![](https://sdn.systemsapproach.org/_images/Slide27.png) ONOS manages the mapping of an abstract specification of network-wide behavior to a collection of per-device instructions.

### 2. 分散式核心 (Distributed Core)

ONOS 核心由多個子系統組成，每個子系統負責管理特定面向的網路狀態 (如拓撲、主機追蹤、封包攔截等)。這些服務大多建立在一個分散式的鍵值儲存系統之上，這個系統是 ONOS 可擴展性與高可用性的基石。

#### **2.1 Atomix Primitives**

Atomix 是 ONOS 使用的鍵值儲存系統，但它不僅僅是個儲存工具，更是一個建構分散式系統的通用框架。它提供了一系列豐富的分散式原語：
*   **分散式資料結構**：如 maps、sets、counters。ONOS 大量使用 `AtomicMap` (保證原子性更新的強一致性) 和 `DistributedMap` (支援最終一致性)。
*   **分散式通訊**：如直接訊息傳遞和發布/訂閱模型。
*   **分散式協調**：如鎖 (locks)、領導者選舉 (leader elections) 和屏障 (barriers)。
*   **群組成員管理 (Group Membership)**：用於協調多個 ONOS 實例。

Atomix 在 ONOS 中扮演著關鍵的協調角色：
1.  **實例管理**：透過**群組成員**原語，ONOS 叢集可以偵測到新加入的實例或已失效的實例。
2.  **主節點選舉 (Mastership)**：為了確保對單一交換器的控制指令一致性，ONOS 叢集會為每一台交換器選舉一個主節點 (master)。只有主節點可以對該交換器下達寫入指令，而所有實例都可以讀取其狀態。當某個 ONOS 實例失效時，叢集會透過 Atomix 的**領導者選舉**原語，為其負責的交換器重新選舉主節點。

#### **2.2 核心服務 (Services)**

ONOS 在 Atomix 之上定義了一系列核心的表格 (maps)，並將它們封裝成各種**服務 (services)** 供應用程式使用。服務與表格是一體兩面：表格是鍵值對的集合，而服務是與這些鍵值對互動的介面。

![](https://sdn.systemsapproach.org/_images/Slide29.png) ONOS provides a set of services, such as the Topology, Device, and Link Services, on top of a corresponding table (Map) implemented in Atomix.

這些服務相互依賴，形成一個服務圖譜 (service graph)。例如：
*   **Path Service** (路徑服務) 依賴於 **Topology Service** (拓撲服務) 和 **Host Service** (主機服務) 來計算主機之間的端到端路徑。
*   **Host Service** 則透過南向的 **Host Location Provider** (一種透過攔截 ARP、DHCP 等封包來發現主機的模組) 來寫入主機資訊。

以下是 ONOS 最常用的一些核心服務：
*   **基礎狀態服務**：
    *   **Host Service**：記錄連接到網路的終端系統。
    *   **Device Service**：記錄網路基礎設施裝置 (如交換器) 的資訊。
    *   **Link Service**：記錄連接基礎設施裝置的鏈路屬性。
    *   **Topology Service**：基於 Device 和 Link 服務，建構一個代表全域網路的圖形抽象。
*   **叢集與配置服務**：
    *   **Mastership Service**：為每個裝置選舉主節點 ONOS 實例。
    *   **Cluster Service**：管理 ONOS 叢集的成員資訊。
    *   **Network Config Service**：允許外部系統 (如 ZTP 應用或維運人員) 預先配置網路的元資訊。
*   **轉發抽象服務**：提供不同抽象層級的網路編程能力。
    *   **Flow Rule Service**：提供裝置為中心、與 pipeline 相關的 match/action 編程。
    *   **Flow Objective Service**：提供裝置為中心、但與 pipeline 無關的抽象編程。
    *   **Intent Service**：提供與拓撲無關的高階編程，應用程式只需宣告連線意圖，由服務負責實現並維護。


### 3. 北向介面 (Northbound Interface, NBI)

ONOS NBI 最核心的部分是其對底層交換器的控制介面，特別是 **Flow Objectives**，它提供了一種與 forwarding pipeline 無關的編程模型。

Flow Objectives 包含三種類型，形成一個抽象的三階段 pipeline：
1.  **Filtering (過濾)**：根據流量選擇器 (Selector) 決定是否允許流量進入 pipeline。
2.  **Forwarding (轉發)**：決定流量如何從 pipeline 中轉發出去，通常是匹配封包欄位並查詢轉發表。
3.  **Next (下一步)**：指示流量應接受何種處理 (Treatment)，例如重寫標頭。

真正的挑戰在於將這些與 pipeline 無關的 objectives 對應到特定裝置、與 pipeline 相關的 flow rules 上。這項工作由 **Flow Objective Service** 負責，它內部使用一種稱為 **Pipeliner** 的裝置驅動行為來實現此對應。

對於 P4 可編程 pipeline，Pipeliner 會利用 **Pipeconf** 結構，該結構根據 P4 編譯器輸出的 `.p4info` 檔案，來綁定 pipeline 模型、驅動程式和目標 pipeline 的轉換器。

![](https://sdn.systemsapproach.org/_images/Slide39.png) Flow Objective Service manages the mapping of pipeline-agnostic objectives onto pipeline-specific rules.

### 4. 南向介面 (Southbound Interface, SBI)

ONOS 的 SBI 採用外掛程式架構，以適應不同的控制協定和異質網路裝置。

*   **協定提供者 (Protocol Providers)**：作為 SBI 和底層網路之間的代理，每個 provider 負責實現一種特定的控制協定 (如 OpenFlow、gNMI)。有些 provider 則間接透過其他 ONOS 服務與網路互動，例如 `LinkProvider` 會使用 `Packet Service` 來攔截 LLDP 封包以發現鏈路。

![](https://sdn.systemsapproach.org/_images/Slide35.png) ONOS Southbound Interface (SBI) is extended by Provider Plugins.

*   **裝置驅動程式 (Device Drivers)**：用於隔離裝置特定的差異，使核心程式碼和 provider 無需關心這些細節。驅動程式本身也作為 ONOS 應用程式部署，可以動態安裝與移除。

### 5. 可擴展效能與高可用性 (Scalable Performance & High Availability)

作為一個邏輯上集中的 SDN 控制器，ONOS 必須確保高效能與高可用性。
*   **效能指標**：ONOS 能夠支援高達 1M 條路由、5M 條 flow rules，並能處理每秒 500k 次的 flow 操作。
*   **部署模型**：生產環境通常部署至少三個 ONOS 實例以確保高可用性。這些實例以 Docker 容器形式運行，並由 Kubernetes 管理。
*   **擴展機制**：所有 ONOS 實例透過 Atomix 分享網路狀態，每個實例只負責一部分交換器的主節點角色。當有實例故障時，其餘實例會透過領導者選舉機制接管，從而實現高可用性。
*   **未來架構 (µONOS)**：ONOS 正在重構為更徹底的微服務架構，稱為 µONOS。在這個新架構中，Atomix、控制應用、南向協定和核心功能 (如拓撲管理、控制管理) 都將被封裝成可獨立擴展的微服務。

![](https://sdn.systemsapproach.org/_images/Slide42.png) Multiple ONOS instances, all sharing network state via Atomix, provide scalable performance and high availability.

總結來說，Network OS (以 ONOS 為例) 是一個基於分散式系統原理建構的平台，它透過分層架構、服務抽象和豐富的分散式原語，提供了一個可擴展、高可用且能管理異質網路的強大控制平面。它不僅是 SDN 的核心，更是實現網路可編程性與自動化的關鍵基礎。

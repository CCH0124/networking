### 第三章：基本架構 (Basic Architecture) 重點整理

本章節的核心目標是定義一個 SDN 網路的軟體架構，這個架構偏好使用可編程的商用硬體，並將控制封包轉送等網路操作的智慧實現在軟體中。為了讓討論更具體，本章以一套開源且經過驗證的組件作為範例，這些組件被設計來協同工作，提供一個無縫的端對端解決方案，並且已在實際的生產網路中運行。

#### 1. 總體軟體堆疊架構 (Overall Software Stack)

此架構是理解現代 SDN 系統的藍圖，由下至上主要包含四個核心層次：

*   **裸機交換器 (Bare-Metal Switch)**：作為資料層的基礎硬體。
*   **交換器作業系統 (Switch OS)**：運行在單台交換器上的本地端作業系統。
*   **網路作業系統 (Network OS)**：一個邏輯上集中、跨越多台交換器的全域控制器。
*   **控制應用程式 (Control Applications)**：實現特定網路功能的應用程式。

這個堆疊的精髓在於其**開放介面 (Open APIs)**。架構圖中明確標示了兩個關鍵的 API 介面：
1.  **南向介面 (Southbound Interface)**：介於 Network OS 與 Switch OS 之間，用於控制交換器的轉送行為。範例中使用的協定包括 `P4Runtime`、`OpenFlow`、`gNMI` 和 `gNOI`。
2.  **北向介面 (Northbound Interface)**：介於 Control Apps 與 Network OS 之間，讓應用程式可以操作網路。範例中使用的介面包括 `FlowObjective`、`gNMI` 和 `gNOI`。

這些 API 大多透過 `gRPC` 作為傳輸協定，這是一個現代化、高效能的遠端程序呼叫 (RPC) 框架。

![Overall architecture of the SDN software stack.](https://sdn.systemsapproach.org/_images/Slide08.png)


**架構師觀點：不僅限於交換器**

這個 SDN 堆疊的視野並不僅限於實體交換器。從端對端的角度來看，軟體堆疊的一部分也運行在終端主機上。
*   **虛擬交換器 (vSwitch)**：通常在伺服器的 hypervisor 中以軟體實現，負責轉送進出虛擬機 (VMs) 的封包。像 Open vSwitch (OVS) 就是一個廣泛使用的開源 vSwitch，它可以支援 OpenFlow 等北向 API，使其行為與實體交換器無異。
*   **智慧網卡 (SmartNIC)**：一種可以分擔 (off-load) 甚至取代 vSwitch 功能的特殊網卡。它可以在硬體層級（如 FPGA 或 ASIC）複製網路交換器中的轉送管線 (forwarding pipeline)。

對 Network OS 而言，vSwitch 和 SmartNIC 都被視為端對端路徑上的另一個交換元件，可以用同樣的 API 進行控制。

#### 2. 裸機交換器 (Bare-Metal Switch)

這是整個架構的硬體基礎，也是資料層 (Data Plane) 的實體。
*   **核心晶片**：交換器圍繞著一個商用矽晶片（如 Intel Tofino 或 Broadcom Tomahawk）打造。Tofino 實現了可編程的轉送管線，而 Tomahawk 則是固定功能 (fixed-function) 的管線。
*   **P4 程式的角色**：無論是可編程還是固定功能的晶片，此架構都使用兩個 P4 程式來定義其轉送管線：
    *   `forward.p4`：定義了期望的轉送行為。對於可編程晶片，它「規定」了管線；對於固定功能晶片，它「描述」了既有的管線。
    *   `arch.p4`：定義了目標晶片的邏輯架構，例如管線有哪些階段、介面是什麼。
*   **為何固定功能晶片也需要 P4？** 這是一個關鍵的架構洞察。即使無法修改其行為，我們仍然需要 `forward.p4` 和 `arch.p4` 來**正式地規格化 (formally specify)** 該管線。P4 編譯器會利用這份規格書，自動生成與資料層溝通的 API，從而實現控制層的自動化與抽象化。


#### 3. 交換器作業系統 (Switch OS)

這是在每台裸機交換器內部通用處理器上運行的本地作業系統。
*   **基礎與核心**：常用的基礎是 `Open Network Linux (ONL)`，一個基於 Debian 的 Linux 發行版。在此之上，範例採用 `Stratum` 作為一個**輕量級交換器作業系統 (Thin Switch OS)**。
*   **核心職責**：Stratum 的主要任務是作為一個 API 轉接層 (shim)，負責處理來自 Network OS 的 API 呼叫，並將其轉譯成對交換器內部資源（特別是交換晶片）的相應操作。
*   **三大北向介面**：Stratum 主要公開三個介面：
    *   `P4Runtime`：用於在運行時**控制**轉送行為，它是填充轉發表和操作轉發狀態的關鍵。例如新增/刪除轉送規則。
    *   `gNMI` (gRPC Network Management Interface)：用於**設定**交換器的配置狀態。
    *   `gNOI` (gRPC Network Operations Interfaces)：用於存取**操作**狀態，如憑證管理、軟體升級或設備測試等。

這清晰地劃分了「控制 (Control)」與「配置 (Configuration)」兩種不同頻率與目的的操作。

#### 4. 網路作業系統 (Network OS)

這是 SDN 的大腦，一個邏輯上集中的控制器，以全網視角來管理和控制一個交換器網路。
*   **範例實作**：本書以 `ONOS (Open Network Operating System)` 作為範例，它在效能、擴展性和可用性方面都是一流的。
*   **三大核心職責**：
    1.  **拓撲管理 (Managing Topology)**：維護網路基礎設施的清單與互連關係，為上層應用提供共享的網路視圖。
    2.  **配置管理 (Managing Configuration)**：在網路層級上，對多個設備進行原子的配置操作，並支援追蹤、回滾和驗證。
    3.  **交換器控制 (Controlling Switches)**：控制資料層的封包處理管線，並管理其中的流規則 (flow rules)、群組 (groups) 等。
*   **關鍵北向抽象**：ONOS 提供了一個名為 `FlowObjectives` 的抽象介面，它以一種**管線無關 (pipeline-independent)** 的方式來定義流規則，讓上層應用無需關心底層交換器的具體管線實現。
*   **架構師觀點：核心內部元件**：任何 Network OS 最關鍵的子系統是**可擴展的鍵值儲存 (Scalable Key/Value Store)**。ONOS 使用一個名為 `Atomix` 的開源專案，該專案實作了 `RAFT` 共識演算法。這正是 ONOS 實現高效能、高可用性與水平擴展能力的基石，也是現代雲端服務的標準設計模式。

#### 5. 葉脊網路架構 (Leaf-Spine Fabric)

* **架構**：它是一種基於 **Leaf-Spine（葉脊式）** 拓撲的網路架構，專為可程式化交換器設計。
    * **Leaf Switch (葉交換器)**：通常作為機櫃頂端交換器 (Top-of-Rack)，直接連接該機櫃內的所有伺服器。
    * **Spine Switch (脊交換器)**：負責連接所有不同的 Leaf 交換器。
* **軟體定義**：它並非單一應用程式，而是運行在 **ONOS** (一個開源的 SDN 控制器) 上的一套 **控制應用程式 (Control Apps)**。

##### 主要功能與角色

SD-Fabric 在網路中扮演三個主要角色：

1.  **內部互連**：作為一個交換結構 (switching fabric)，連接資料中心內多個機櫃的伺服器與虛擬機 (VM)。
2.  **對外連接 (上游)**：將整個叢集連接到上游網路，例如網際網路 (Internet)，此時它的行為類似一個路由器。
3.  **對下連接 (下游)**：將叢集連接到下游的接取網路，例如 PON (無源光纖網路) 或 RAN (無線接取網路)。

簡單來說，SD-Fabric 是一個位於 **網路邊緣** 的、高度整合的互連解決方案。

##### 運作與實作方式

* **內部控制**：ONOS 上的控制應用程式是透過下達 **Flow Objectives (流目標)** 來控制網路行為，而非依賴傳統的路由協定。
* **外部通訊**：當需要與外部世界（例如上游的核心路由器）溝通時，才會使用標準的 **BGP 協定**。這也是 SDN 環境中常見的模式：內部創新，對外兼容。
* **支援的關鍵功能**：
    * VLANs 和 L2 橋接
    * IPv4/IPv6 單播和多播路由
    * DHCP L3 中繼
    * 伺服器和上游路由器的雙主機備援 (Dual-homing)
    * QinQ 轉發/終端
    * 基於 MPLS 的虛擬線路 (Pseudowires)

##### 擴展性

SD-Fabric 的設計具有高度彈性，不僅限於單一資料中心。它可以擴展到 **多個站點 (multi-site)**，並能整合行動網路的 **基地台 (Base Stations)**，形成一個分散式的葉脊式網路結構。

![](https://sdn.systemsapproach.org/_images/Slide09.png) SD-Fabric suite of control apps managing a (potentially distributed) leaf-spine fabric.



總結來說，第三章為我們建立了一個從硬體到應用的完整 SDN 系統藍圖。它強調了分層、解耦、開放 API 的重要性，並透過一套具體的開源組件 (Trellis on ONOS on Stratum) 展示了如何將 SDN 的理念轉化為一個可部署、可維運的實際網路架構。

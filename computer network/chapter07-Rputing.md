# 路由選擇
## 自治系統
從所有路由器執行相同的路由選擇演算法來計算整個網路的路由路徑選擇，因此一台路由器很難和同另一台路由器區別分開。

- 規模
    - 路由器不斷增大，涉及路由選擇訊息的通訊、計算和儲存的成本將會變大
        - 如此大的路由器在 DV 演算法中江永源無法收斂
- 管理自治
    - Internet 是 ISP 的網路
    - ISP 通常希望按自己的意願運行路由器
        - 像是自己的網路中運行它所選的某種網路由選擇演算法
        - 對外部隱藏其網路內部組織
    - 在理想上，一個組織能按照自己的想法運行和其網路，還能將其網路與其他外部網路連接

上述的問題可用自治系統（Autonomous System, AS）解決，而 AS 通常由一組處在相同管理控制下的路由器組成。

在相同 AS 中的路由器豆運行相同的路由演算法並且有彼此資訊，在一個自治系統內運行的路由演算法叫做**自治系統內部路由選擇協定(intra-autonomous system routing protocol)**

## OSPF
- 鏈路狀態協定，使用 flooding 和 Dijkstra 最低成本路徑演算法
- 各條鏈路成本是由管理員配置
- 每當鏈路發生變化時，路由器會發送廣播鏈路狀態訊息，就算未變化也會週期性的發送，這樣增加了穩定性
- OSPF 訊息由 IP 承載，對 OSPF 其上層協定的值為 89
- OSPF 自行實現可靠訊息傳輸、鏈路狀態廣播等
- OSPF 必須檢查鏈路是否正在運行，使用 HELLO 訊息確認，也允許獲得相鄰的網路範圍鏈路狀態的資料庫

### OSPF 優點
- 安全
    - 驗證 OSPF 間的訊息交換
        - MD5
- 多條相同成本路徑
    - 到達目的地有多條相同成本路徑時，OSPF 允許使用多條路徑
        - 可分流
- 對單播與多播路由選擇的綜合支援
- 支持在單個 AS 中的層次結構
    - OSPF 自治系統能夠層次畫配置多個區域
        - 區域內的路由器可相互廣播其鏈路狀態，而區域內會有一台或多台區域邊界路由器負責為 flow 向該區域以外的封包提供路由選擇
    - 在 AS 中只有一個 OSPF 區域配置主幹區
        - 負責為該 AS 中其他區域之間的流量提供路由選擇
        - 主幹包含 AS 中的所有區域邊界路由器或著非區域邊界路由器
    - 在 AS 中的區域間的路由選擇要求封包先路由到一個區域邊界路由器(區域路由選擇)，接著透過主幹路由到位於目的區域的區域邊界路由器，進而在路由到最終目的地


## ISP 之間的路由選擇：BGP
當封包跨越多個 AS 進行路由時，需要一個**自治系統間路由選擇協定(inter-autonomous system routinh protocol)**。AS 通訊必須訊行相同的 AS 間路由選擇協定，在網際網路上，AS 運行相同的 AS 間路由選擇協定，稱為**邊界網關協定(Broder Gateway Protocol, BGP)**。

### BGP 的作用
在 BGP 中，封包並不是路由到一個特定的目的地，想反是路由到 CIDR 化的前綴(一個子網或一個子網集合)。一台路由器的轉發表將具有形式為 $(x, 1)$ 的表項，$x$ 是一個前綴(192.168.10/22)，$I$ 是該路由器接口之一的接口號。

BGP 為 AS 間的的路由協定，而 BGP 為每台路由器提供一種完成以下任務的手段：
1. Obtain prefix reachability information from neighboring ASs
- BGP 將每個子網向網際網路的其餘部分通告它的存在
    - BGP 確保所有 AS 知道該子網，否則將不會擁有該目的地
2. Determine the “best” routes to the prefixes
- 一台路由器可能知道兩條或更多條到特定前綴的不同路由
    - BGP 使用它經過相鄰路由器獲得的前綴可達性做策略

### 通告 BGP 路由訊息

![](https://i.imgur.com/wOtIfZK.png)

上圖 AS3 包括前綴 $x$ 的子網，而對於每個 AS，每台路由器要嘛是**網關路由器(gatewa router)** 或是**內部路由器(internel router)**。而 gatewa router 是位於 AS 邊緣路由器，連接其它 AS 中一台或多台路由，internel router 連接自己 AS 中的主機或路由器。


然而在 BGP 中，每對路由器透過使用 179 端口的半永久 TCP 連線交換路由選擇訊息。
- 每條直接連接以集所有透過該連接發送的訊息，稱做 **BGP連接(BGP connection)**
- 跨兩個 AS 的 BGP 連接稱為**外部 BGP(eBGP)**，而在相同 AS 內則為**內部BGP(iBGP)**，如下圖

![](https://i.imgur.com/dvUo5ki.png)

為了傳播可達訊息，使用 iBGP 和 eBGP 會話。

![](https://i.imgur.com/iTmj9An.png "圖3")
圖3

上圖表示 AS1 和 AS3 之間增加對等鏈路後的網路。


### 確定最好的路由
從給定路由器到一個目的地子網可能有多條路徑。事實上，網際網路路由器常常接收到很多不同的可能路徑的可達訊息。

當路由器透過 BGP 連接通告前綴時，它在前綴中包括一些**BGP 屬性**。前綴即其屬性稱為路由(route)。較為重要屬性為*AS-PATH*和*NEXT-HOP*。

- AS-PATH
    - 包含通告已經通過的 AS 的列表
    - 如上節的圖3，AS1 到子網 $x$
        - AS-PATH  "AS2 AS3" 和 "AS3"
    - 此屬性可檢測和防止路由迴圈
        - 一台路由在路徑列表中看到包含自己的 AS，會拒絕該通告
- NEXT-HOP
    - 是 AS-PATH 起始的路由接口的 IP 地址
    - 上圖3，對於從 AS1 透過 AS2 到 $x$ 的路由 "AS2 AS3 $x$"，屬性 NEXT-HOP 是路由器 2a 左邊 IP 接口的 IP 地址，而 AS1 值達到 $x$ 的路由 "AS3 $x$"，其 NEXT-HOP 是路由器 3d 最左邊接口的 IP 地址

從這邊每條 BGP 路由包含 NEXT-HOP、AS-PATH 和目的前綴三個組件，實際上是更多。

##### Hot potato routing

![](https://i.imgur.com/4lgJJdF.png)

上圖中總結了一台路由器轉發表中對 `Hot potato routing` 選擇增加 AS 向外前綴的步驟。

 `Hot potato routing` 的主要思想是，對於路由器 1b，盡可能的將封包送出其 AS（用最低開銷），而不擔心其 AS 外部到目的地的餘下部分的開銷。
 
 ##### Route-Selection Algorithm
 如果到相同的前綴有兩條或多條路由，則依序調用下列消除規則值到剩餘一條路由：
 1. 路由被指派一個**本地偏好(local preference)**值作為其屬性之一，該值是一種決策決定，它完全取決於該 AS 的網路管理員，且值越高該路由將被選擇
 2. 從剩餘的路由中(所有都具有相同的最高本地偏好值)，將選擇具有最短 AS-PATH 的路由。假設該規則是路由選擇的唯一規則，則 BGP 將使用 DV 演算法決定路徑，其中距離的度量用 AS 跳得跳數非路由器
 3. 從剩餘的路由中(所有都具有相同的最高本地偏好值和相同的 AS-PATH 長度)，使用 `Hot potato routing` 選擇具有最靠近 NEXT-HOP 路由器的路由
 4. 最後還是多條路由，該路由器使用 BGP 標示符來選擇路由

### IP Anycast
BGP 也常用於實驗 IP 任播服務，該服務通常用於*DNS*中。

![](https://i.imgur.com/g7vXW90.png)

上圖描述 CDN 可能使用 IP 任播方式。在 IP 任播配置階段，CDN 公司為它的多台服務器指派相同 IP 地址，並使用標準的 BGP 從這些服務器的每台來公告該 IP 地址。

實踐上 CDN 通常選擇不使用 IP 任播，因為 BGP 路由選擇變化能夠導致相同的 TCP 連接的封包到達 Web 服務器的不同實例。但 DNS 卻廣泛將其應用於將 DNS 請求指向最近的根服務器。

#####  Routing Policy
AS 的路由決策能夠勝過所有其它考慮，如最短 AS 路徑或`Hot potato routing`等。在路由演算法中，時寄上首先根據本地偏好屬性選擇路由，本地偏好值由本地 AS 的策略所訂。

![](https://i.imgur.com/N9hF7Ng.png)

上圖有六個互聯的自治系統，A、B、C、W、X 和 Y 都為 AS 並非路由器。W、Y 為接入 ISP，X 是一個**多宿接入 ISP(multi-homed stub network)**，其為經由兩個不同的提供商達到網路的其餘部分。透過 BGP 通告可以實現不讓 X 轉發 B 與 C 之間流量。

在商業運行的 ISP 們都遵守一個經驗法則：任何穿越某 ISP 主幹網的流量必須是其源或目的位於該 ISP 的某個客戶網中；不然的話這些流量將會免費搭車透過該 ISP 的網路。

##### AS 間和 AS 內部路由協定不同
- Policy
    - 在 AS 間，策略問題起主導作用
    - 一個給定 AS 產生的流量不能穿越過一個特定的 AS
- Scale
    - 擴展一個路由協定演算法和樹據結構以處理到大量網路或大量網路間的路由協定的這種能力
    - 
- Performance
